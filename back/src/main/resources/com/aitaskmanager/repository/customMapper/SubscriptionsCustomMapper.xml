<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aitaskmanager.repository.customMapper.SubscriptionsCustomMapper">
  <insert id="insertSubscription">
    INSERT INTO subscriptions (user_sid, plan_sid, stripe_subscription_id, status, started_at, expires_at, updated_at)
    VALUES (#{userSid}, #{planSid}, #{stripeSubscriptionId}, 'ACTIVE', CURRENT_TIMESTAMP, #{expiresAt}, CURRENT_TIMESTAMP)
  </insert>
  <select id="hasActive" resultType="int">
    SELECT COUNT(1)
    FROM subscriptions
    WHERE user_sid = #{userSid}
      AND plan_sid = #{planSid}
      AND status = 'ACTIVE'
      AND (expires_at IS NULL OR expires_at > CURRENT_TIMESTAMP)
  </select>
  <select id="selectLatestStartedAt" resultType="java.sql.Timestamp">
    SELECT started_at
    FROM subscriptions
    WHERE user_sid = #{userSid}
      AND status = 'ACTIVE'
      AND (expires_at IS NULL OR expires_at > CURRENT_TIMESTAMP)
    ORDER BY started_at DESC
    LIMIT 1
  </select>
  <select id="selectActivePlanSid" resultType="int">
    SELECT plan_sid
    FROM subscriptions
    WHERE user_sid = #{userSid}
      AND status = 'ACTIVE'
      AND (expires_at IS NULL OR expires_at > CURRENT_TIMESTAMP)
    ORDER BY started_at DESC
    LIMIT 1
  </select>
  <select id="selectActiveStripeSubscriptionId" resultType="string">
    SELECT stripe_subscription_id
    FROM subscriptions
    WHERE user_sid = #{userSid}
      AND status = 'ACTIVE'
      AND (expires_at IS NULL OR expires_at > CURRENT_TIMESTAMP)
    ORDER BY started_at DESC
    LIMIT 1
  </select>
  <update id="cancelActiveByUserSid">
    UPDATE subscriptions
    SET status = 'CANCELLED', updated_at = CURRENT_TIMESTAMP
    WHERE user_sid = #{userSid}
      AND status = 'ACTIVE'
  </update>
  <select id="selectActiveWithStripeId" resultType="map">
    SELECT stripe_subscription_id, user_sid
    FROM subscriptions
    WHERE status = 'ACTIVE'
      AND stripe_subscription_id IS NOT NULL
  </select>
  <update id="updateExpiresAtByStripeId">
    UPDATE subscriptions
    SET expires_at = #{expiresAt}, updated_at = CURRENT_TIMESTAMP
    WHERE stripe_subscription_id = #{stripeSubscriptionId}
  </update>
  <update id="cancelByStripeId">
    UPDATE subscriptions
    SET status = 'CANCELLED', expires_at = #{canceledAt}, updated_at = CURRENT_TIMESTAMP
    WHERE stripe_subscription_id = #{stripeSubscriptionId}
  </update>
</mapper>